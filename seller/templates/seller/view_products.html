{% extends 'seller_base.html' %}
{% load static %}
{% block content %}
</aside>
<main class="flex-1 p-6 space-y-8">
 <section class="flex items-center justify-center gap-10 border rounded-lg p-6" style="border-color:#d1d5db">
  <img alt="Illustration of a woman standing next to a large analytics screen with charts, graphs, and icons representing sentiment analysis" class="w-[200px] h-[140px] object-contain" height="140" src="{% static 'images/Group 225.png' %}" width="200"/>
  <h1 class="text-teal-700 font-semibold text-xl md:text-2xl">
   Sell online with Sentimart
  </h1>
 </section>

 <section class="max-w-4xl mx-auto">
     <h3 class="text-[#4C888E] text-center font-semibold text-[1.5rem] mb-4">
      Approved Products
     </h3>
     <!-- Tabs -->
     <div class="flex space-x-4 mb-6 justify-center items-center">
        <a href="{% url 'view_products' %}?status=approved" class="px-4 py-2 rounded {% if current_status == 'approved' %}bg-[#4C888E] text-white{% else %}bg-gray-200{% endif %}">Approved Products</a>
        <a href="{% url 'view_products' %}?status=pending" class="px-4 py-2 rounded {% if current_status == 'pending' %}bg-[#4C888E] text-white{% else %}bg-gray-200{% endif %}">Under Review products</a>
        <a href="{% url 'view_products' %}?status=rejected" class="px-4 py-2 rounded {% if current_status == 'rejected' %}bg-[#4C888E] text-white{% else %}bg-gray-200{% endif %}">Rejected products</a>
     </div>
     <!-- Product Cards -->
     <div class="space-y-6">
      <!-- Product Card 1 -->
       {% if products %}
       {% for product in products %}
      <article class="border border-gray-300 rounded-md p-4 flex flex-col md:flex-row md:space-x-6">
       <div class="flex flex-col items-center mb-4 md:mb-0">
        <img alt="User avatar of a man with short brown hair and blue shirt" class="rounded-full w-14 h-14 mb-1" height="60" src="https://storage.googleapis.com/a1aa/image/0337b1a1-8046-4f60-7380-04dcf84ddb17.jpg" width="60"/>
        <div class="text-center text-[10px] text-[#475569]">
         <p class="font-semibold text-[11px]">
          {{product.seller.username }}
         </p>
         <p>
          {{product.seller.email}}
         </p>
        </div>
       </div>
       <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Left info box -->
        <div class="border border-gray-300 rounded-md p-3 text-[11px]">
         <table class="w-full text-left text-[11px]">
          <tbody>
           <tr>
            <td class="pr-2 font-semibold">
             Sl no
            </td>
            <td>
             {{product.id}}
            </td>
           </tr>
           <tr>
            <td class="pr-2 font-semibold">
             product category
            </td>
            <td>
             {{product.category}}
            </td>
           </tr>
           <tr>
            <td class="pr-2 font-semibold">
             product sub category
            </td>
            <td>
             {{product.sub_category}}
            </td>
           </tr>
           <tr>
            <td class="pr-2 font-semibold">
             Brand name
            </td>
            <td>
             {{product.brand_name}}
            </td>
           </tr>
           <tr>
            <td class="pr-2 font-semibold">
             Approved date
            </td>
            <td>
             04-5-2025
            </td>
           </tr>
           <tr>
            <td class="pr-2 font-semibold">
             Model number
            </td>
            <td>
             {{product.model_number}}
            </td>
           </tr>
           <tr>
            <td class="pr-2 font-semibold">
             status
            </td>
            <td class="text-[#22c55e] font-semibold {% if product.status == 'approved' %} text-[#22c55e] {% else %} text-[#ef4444] {% endif %} ">
             {{product.status}}
            </td>
           </tr>
           <tr>
            <td class="pr-2 font-semibold">
             Date listed
            </td>
            <td>
             {{product.created_at|date:"d-m-Y"}}
            </td>
           </tr>
           <tr>
            <td class="pr-2 font-semibold">
             last update
            </td>
            <td>
             04-5-2025
            </td>
           </tr>
          </tbody>
         </table>
         <p class="mt-2 text-[10px]">
          Description :
          <br/>
          {{product.description}}
         </p>
         <p class="text-[10px] mt-2">
        SKU: <span class="text-blue-500 ml-2 sku">{{ product.sku }}</span><br/>
        Stock: <span class="text-red-500 font-medium stock-count">{{ product.stock }}</span>
        </p>
         <button
        class="update-stock-btn mt-2 bg-[#3b82f6] text-white text-[10px] px-2 py-0.5 rounded"
        type="button"
        data-sku="{{ product.sku }}"
        data-stock="{{ product.stock }}"
        data-id="{{ product.id }}"
        >
        Add stock
        </button>

        </div>
        <!-- Right image and text -->
        <div class="flex flex-col items-center text-[10px]">
         <img alt="Innowash Range washing machine white and maroon color front view" class="w-28 h-28 object-contain mb-2" height="120" src="{{product.image.url}}" width="120"/>
         <p class="text-[11px] font-semibold mb-0.5">
          {{product.name}}
         </p>
         <p class="text-[#3b82f6]">
          Price :
          <span class="font-semibold">
           {{product.base_price}}
          </span>
         </p>
         <p class="text-[#22c55e]">
          discount :
          <span class="font-semibold">
           {{ product.discount_percentage|floatformat:0 }}%
          </span>
         </p>
        </div>
       </div>
      </article>
      {% endfor %}
      {% else %}
      <p class="text-center text-[#475569]">No products</p>
      {% endif %}
     </div>
    </section>
</main>


<!-- Modal Overlay -->
    <div
      id="modalOverlay"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h2 class="text-xl font-semibold mb-4">Inventory information</h2>

        <div class="mb-4">
          <p class="text-gray-700 mb-1">SKU</p>
          <p id="modalSku" class="text-blue-500">{{product.sku}}</p>
        </div>

        <div class="mb-6">
          <label for="stockCount" class="block text-gray-700 mb-1"
            >Update new stock count</label
          >
          <div class="flex">
            <input
              type="number"
              id="stockCount"
              class="border border-gray-300 rounded !rounded-button p-2 w-24 focus:outline-none focus:ring-2 focus:ring-blue-500"
              value="{{ product.stock }}"
            />
          </div>
        </div>

        <div class="flex justify-end">
          <button
            id="cancelBtn"
            class="mr-2 bg-gray-200 text-gray-800 py-2 px-4 rounded !rounded-button whitespace-nowrap"
          >
            Cancel
          </button>
          <button
            id="confirmBtn"
            class="bg-teal-600 text-white py-2 px-4 rounded !rounded-button whitespace-nowrap"
          >
            Update
          </button>
        </div>
      </div>
    </div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
  const modalOverlay = document.getElementById("modalOverlay");
  const modalSku = document.getElementById("modalSku");
  const stockCountInput = document.getElementById("stockCount");
  const cancelBtn = document.getElementById("cancelBtn");
  const confirmBtn = document.getElementById("confirmBtn");

  const csrftoken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  let currentProductId = null;

  const updateButtons = document.querySelectorAll(".update-stock-btn");

  updateButtons.forEach((button) => {
    button.addEventListener("click", function () {
      const sku = this.dataset.sku;
      const stock = this.dataset.stock;
      const productId = this.dataset.id;

      currentProductId = productId;

      modalSku.textContent = sku;
      stockCountInput.value = stock;

      modalOverlay.classList.remove("hidden");
    });
  });

  cancelBtn.addEventListener("click", function () {
    modalOverlay.classList.add("hidden");
  });

  confirmBtn.addEventListener("click", function () {
    const newStockValue = stockCountInput.value;
    const sku = modalSku.textContent;

    fetch("{% url 'update_stock' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrftoken,
      },
      body: `sku=${encodeURIComponent(sku)}&new_stock=${encodeURIComponent(newStockValue)}`,
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("Stock updated successfully!");

     
          document.querySelectorAll(".update-stock-btn").forEach((btn) => {
            if (btn.dataset.sku === sku) {
              btn.dataset.stock = newStockValue;
              const card = btn.closest("article");
              const stockElement = card.querySelector(".stock-count");
              if (stockElement) stockElement.textContent = newStockValue;
            }
          });

          modalOverlay.classList.add("hidden");
        } else {
          alert("Error: " + data.message);
        }
      })
      .catch(error => {
        alert("Request failed");
        console.error(error);
      });
  });

  modalOverlay.addEventListener("click", function (e) {
    if (e.target === modalOverlay) {
      modalOverlay.classList.add("hidden");
    }
  });
});

</script>

<script>
    confirmBtn.addEventListener("click", function () {
  const newStockValue = stockCountInput.value;
  const sku = modalSku.textContent;

  fetch("{% url 'update_stock' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "X-CSRFToken": "{{ csrf_token }}", 
    },
    body: `sku=${sku}&new_stock=${newStockValue}`,
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("Stock updated successfully!");

    
        document.querySelectorAll(".sku").forEach((skuElement) => {
          if (skuElement.textContent === sku) {
            const card = skuElement.closest(".border");
            const stockElement = card.querySelector(".stock-count");
            stockElement.textContent = newStockValue;
          }
        });

        modalOverlay.classList.add("hidden");
      } else {
        alert("Error: " + data.message);
      }
    })
    .catch(error => {
      alert("Request failed");
    });
});

</script>

{% endblock %}