{% extends './base.html' %}
{% block content %}
<div class="container my-4">
    <div class="card">
        <div class="card-header bg-[#4C888E] text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">E-commerce Assistant</h3>
            <span class="badge bg-light text-dark">Online</span>
        </div>
        <div class="card-body" style="height: 400px; overflow-y: auto; display: flex; flex-direction: column;" id="chat-messages">
            <!-- Messages will appear here -->
        </div>
        <div class="card-footer">
            <div class="mb-2">
                <small class="text-muted">Try asking:</small>
                <div class="d-flex flex-wrap gap-2 mt-1">
                    <button class="btn btn-sm btn-outline-secondary quick-question">Where is my order?</button>
                    <button class="btn btn-sm btn-outline-secondary quick-question">What is SentiMart Prime?</button>
                    <button class="btn btn-sm btn-outline-secondary quick-question">Delivery options?</button>
                </div>
            </div>
            <div class="input-group">
                <input type="text" class="form-control" id="user-input" 
                       placeholder="Ask about your order or products..." autocomplete="off">
                <div class="input-group-append">
                    <button class="btn btn-primary" id="send-btn">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const quickQuestions = document.querySelectorAll('.quick-question');
    
    function addMessage(message, isBot) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-2 p-3 rounded ${isBot ? 'bg-light text-dark align-self-start' : 'bg-primary text-white align-self-end'}`;
        messageDiv.style.maxWidth = '80%';
        messageDiv.style.whiteSpace = 'pre-line';
        
        // Handle HTML content safely
        if (isBot && message.includes('<a href')) {
            const temp = document.createElement('div');
            temp.innerHTML = message;
            messageDiv.appendChild(temp);
        } else {
            messageDiv.textContent = message;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;
        
        addMessage(message, false);
        userInput.value = '';
        
        fetch('/chat/api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({message: message})
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.response) {
                addMessage(data.response, true);
            }
        })
        .catch(error => {
            addMessage("Sorry, I'm having trouble connecting. Please try again later.", true);
            console.error('Error:', error);
        });
    }
    
    // Quick question buttons
    quickQuestions.forEach(button => {
        button.addEventListener('click', function() {
            userInput.value = this.textContent;
            sendMessage();
        });
    });
    
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Initial bot greeting with typing indicator
    setTimeout(() => {
        addMessage("Hello! I'm your SentiMart assistant. I can help you with:\n\n• Order tracking\n• Delivery questions\n• Prime membership\n• Payment issues\n\nHow can I help you today?", true);
    }, 500);
});
</script>

<style>
#chat-messages {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.quick-question {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

/* Typing indicator animation */
@keyframes blink {
    0% { opacity: 0.2; }
    50% { opacity: 1; }
    100% { opacity: 0.2; }
}

.typing-indicator span {
    animation: blink 1.4s infinite;
}
.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}
.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}
</style>
{% endblock %}